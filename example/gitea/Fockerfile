base: freebsd-11.2

steps:
  - run:
      - ASSUME_ALWAYS_YES=yes pkg bootstrap
      - ASSUME_ALWAYS_YES=yes IGNORE_OSVERSION=yes pkg install gmake go git git-lfs ca_root_nss
  - run:
      - ASSUME_ALWAYS_YES=yes pkg remove go
      - ASSUME_ALWAYS_YES=yes IGNORE_OSVERSION=yes pkg install subversion
      - svn checkout --depth immediates https://svn.FreeBSD.org/ports/tags/RELEASE_12_1_0 ports-12.1.0
      - cd ports-12.1.0
      - svn update --set-depth immediates lang
      - svn update --set-depth infinity lang/go
      - svn update --set-depth infinity lang/go14
      - svn update --set-depth infinity Mk
      - svn update --set-depth infinity Templates
      - svn update --set-depth infinity Tools
      - svn update --set-depth infinity Keywords
      - cd lang/go
      - ALLOW_UNSUPPORTED_SYSTEM=yes BATCH=yes make install clean
      - cd /
      - rm -rvf /ports-12.1.0
  - run:
      - ASSUME_ALWAYS_YES=yes pkg remove go14
      - svn checkout --depth immediates https://svn.FreeBSD.org/ports/head ports-head
      - cd ports-head
      - svn update --set-depth immediates www
      - svn update --set-depth infinity www/gitea
      - svn update --set-depth infinity Mk
      - svn update --set-depth infinity Templates
      - svn update --set-depth infinity Tools
      - svn update --set-depth infinity Keywords
      - cd www/gitea
      - ALLOW_UNSUPPORTED_SYSTEM=yes BATCH=yes make install clean
      - cd /
      - rm -rvf /ports-head
  - run:
      - ASSUME_ALWAYS_YES=yes pkg remove gmake go
      - ASSUME_ALWAYS_YES=yes pkg autoremove
  - run:
      - mkdir -p /var/db/gitea
      - sysrc sshd_enable=NO
      - sysrc gitea_enable=YES
      - sysrc sendmail_enable=NONE
      - sysrc syslogd_flags="-ss"
      - sed -i -e 's/DISABLE_REGISTRATION[ \t]*=[ \t]*false/DISABLE_REGISTRATION = true/g' /usr/local/etc/gitea/conf/app.ini
      - chown root:git /usr/local/etc/gitea/conf/app.ini
      - chmod 640 /usr/local/etc/gitea/conf/app.ini
